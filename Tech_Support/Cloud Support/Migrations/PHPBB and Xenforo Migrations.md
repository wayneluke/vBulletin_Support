# Migration Process

## Overview

### General

The migration process is a two step process.  First the source data needs to be exported to a simplified migration schema.  Then the migration schema needs to be imported into vBulletin.  This is intended to improve modularity in the development process as well in the execution.  For instance the export could be run on the customer’s server and the migration schema dumped and fed into a cloud process.  Eventually we may allow exporting to a file instead of a database if there is a use case for it.

### Workflows

Workflows are the stitched together modules that produce a migration process.  They consist of an import and export module that share a migration schema and produce a process from a source DB version to a particular vBulletin version.  Note that most importers will necessarily target older versions of vBulletin.  We rely as much as possible on existing maintenance tools to avoid development work and this includes the upgrader.

## Initial Steps

1. Choose workflow.  The defining characteristics of workflow are
    - Source DB type and version (PHPBB 3.0.3)
    - Migration Schema version
    - Target vBulletin Version
2. The export is defined as “DB type and version to Migration Schema”
3. The import is defined as “Migration Schema to vBulletin Version”
4. The migration schema version must match for the chosen import and export
5 Currently there are a very limited set of importers and exporters to choose from.
6 Some prepacked workflow apps are available as phars.

## Using Workflows 

1. The workflow needs to be configured.  It falls into several parts
    - Source database (used by the exporter)
    - Migration database (used by the both)
    - vBulletin installation (used by the importer)
    - Source Filedata (used by the importer)
    - Options (depends on the option)

2. Create the configuration file.  This should be named config.php and exist in the same directory as the workflow file.
    - $config['sourcedsn'] : dsn for the source database, including db name
    - $config['sourceprefix'] : table prefix to use for any tables in the source
    - $config['schemadsn'] : The dsn for the migration schema, this should not include the db name.  This does not need to be located on the same db server as the source.
    - $config['schemadb'] : db name for the migration schema.  This should be considered a scratch workspace.  The db will be created if it doesn’t exist and overwritten if it does.  Any information in it will be lost.
    - $config['vbulletinroot'] : root directory for the vbulletin instance that the data will be imported into.  Note that the importer will use the vBulletin installation for processing and will use the configuration there to find the database.
    - $config['attachmentpath'] : The attachments for the source file. The expected format is source specific but for current implementations should be the attachment directory from the host system copied directly.
    - $config['invalidattachmentpath']: a directory to store any attachments that the importer failed to import.
    - $config['exclude']['user']: array of user ids (in whatever format the source database uses).  These user’s will not be exported and any posts will be assigned to Guest.  This is intended to allow users that will cause problems with the export to be excluded (for instance duplicate user names or emails – but see below).  Problem users frequently don’t have any posts and won’t be missed.
    - $config['options']['allowdupemail']: (true or false) allow duplicate emails in the export data.  We don’t allow this in vBulletin by default but it is an option and if the source data has a lot of such users excluding the duplicates may be both tedious and not what the customer wants. You may also want to set the “Require Unique Email Address” option to off but it’s not required for the system to work with existing duplicate emails.  This is not currently done automatically by the importer. (This is only implemented for migration schema 1.01 and higher).
    - $config[‘options’][‘memory_limit’]: Sets the PHP memory limit (the exporter keeps attachment/quote information in memory for all posts and this can be a lot).  Honors k/m/g suffixes (so ‘512m’ is valid).  Does not check the current limit before setting so you can lower the limit with this setting.

3. Run actions.  php type.phar –action=action (eg. php phpbb.phar –action=export)

4. Available actions (list can be displayed by running the script without an action)
    - version : show the versions that this workflow is configured to use.
    - checksource: Run some diagnostics on the source db.  What this does is export/source dependent and extremely rough.  It primarily is useful for showing potentially duplicated username/emails for use with the exclude user and allowduemail options above.
    - checkschema : Similar check on the schema generated by the export.  Similarly rough.
    - export : Export the db to the configured schema.
    - import : Import the schema to the configured blank vBulletin install.

## Export Data

1. Ensure that the configuration required for the export is set.
2. Run the export action.

## Import Data

1. Download and install the version of vBulletin that the importer targets.
2. Configure vBulletin with any options that affect the import process.  For instance attachments will be imported according to the configured storage settings.
3. Ensure that the configuration required for the import is set.
4. If necessary, migrate the import database and attachments to the server that vBulletin will run on. The migration database *must* be on the same database server as vBulletin.
5. Run the import action.  This must be done on the same server as the vBulletin installation.

## Complete Migration

1. Upgrade vbulletin to current version
2. Run the following from the maintenance page in admincp
3. Rebuild Forum Information
4. Rebuild Topic Information
5. Rebuild Search Index
6. Update Post Counts
7. Update PM counts
8. Update User Titles and Ranks

> Note: that additional work will need to be done by the user to finish the export.  We make no attempt, for instance, to configure permissions for any of the imported user groups. 

## Import Items

The following items will be imported.

- Ban IP/Email settings
- User groups
- Users
- User/user group mappings
- User Bans
- Forums
- Threads/Posts
- Attachments
- Private Messages (not implemented for PHPBB)

#cloud
#migration
